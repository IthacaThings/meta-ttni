# The Things Network Ithaca mLinux layer

This layer depends on: meta-mlinux

# Overview

This layer modifies
[mLinux](http://www.multitech.net/developer/software/mlinux/) for
specific requirements of [The Things
Network](https://console.thethingsnetwork.org/) and for maintaining a
large number of gateways.  It does this by:

## Reducing the size of the Conduit image

Reducing the amount of bandwidth and storage that is needed for an
update.  The following packages are removed. They can be re-installed
via _opkg_ command.

+ mosquitto 
+ PHP
+ gpsd
+ java
+ lighttpd
+ lora packages
+ perl
+ ruby
+ sqlite3

### Adding packages to Conduit AP

The Conduit AP system comes with a minimial configuration that does
not have packages installed needed to run TTN and Ansible.  These are
added by default so they do not need to be manually installed.

## Adding useful tools

+ Useful utilities (sudo, htop, ntp, ntp-utils, logrotate)
+ python packages required by Ansible (python-distutils, python-json,
  python-pkgutil, pythong-shell)
+ Dependencies mp-packet-forwarder (libmpsse)

A future goal is to remove node.js, but this is required to generate
the configuration files for the packet forwarder

## Modifications of existing packages

### Monit

Includes a later version

### openssl-bin

Remove the dependency on perl.
This breaks the */usr/bin/c_rehash* script, which requires perl, but
the *openssl rehash* command still works.

### ca-certificates

Removes the DST_CA_Root_X3 certificate.
This certificate expired and broke Let's Encrypt Certificates.

## Preserving configuration

The _preserve_ package adds two init scripts:

### preserve_config

This runs at shutdown and if /var/volatile/do_flash_upgrade exists,
makes a list of links into /var/config and stores them as an
executable shell script.

### restore_config

This runs at startup only at the first boot after a firmware upgrade
and runs all scripts in /var/config/restore.d and /var/oem/restore.d
with run-parts.

## DHCP by default

The default configuration with this image is DHCP on the Ethernet
interface. This configuration is only applied if the file
_/var/config/force_defaults_ exists when a Conduit is booted.

# Usage

## Configure

+ Configure the MACHINE in *conf/local.conf* (_mtcdt_ for Conduit, _mtcap_ for Conduit AP)
+ If you are updating a downloaded image, copy _ROOT_PASSWORD_ and
  __ROOT_PASSWORD_HASH_ into *conf/local.conf*
+ Check out this layer and move it in place of *layers/user.layer*. 
  Don't use symlinks when using the containerized build environment mentioned below.
  
## Build

Build the ttni image:
```
$ bitbake ttni-base-image
```
+ Deploy the images from _build/tmp/deploy/image/mtcdt_ or _build/tmp/deploy/image/mtcap_.
```
$ scp -p build/tmp/deploy/image/mtcdt/ttni-base-image-mtcdt-upgrade-withboot.bin root@GATEWAYIP
$ ssh root@GATEWAYIP /usr/sbin/mlinux-firmware-upgrade /home/root/ttni-base-image-mtcdt-upgrade-withboot.bin
```

## Scripted build

A handy script exists in *scripts/populate* that can be used to build
both the _mtcap_ and _mtcdt_ versions of the kernel and copy to a
public repo.

```
$ layers/user-layer/scripts/populate 5.3.0b
```

The above command will create *../mlinux-images/5.3.0b* and populate
it with the upgrade images and other files generated by bitbake:

```
jch@mittens[561]:mlinux-5.3.0b$ ls -l ../mlinux-images/5.3.0b/*
../mlinux-images/5.3.0b/mtcap:
total 92456
-rw-r----- 1 jch users     8184 May 27 20:35 at91bootstrap_pmecc_padded.bin
-rwxr-xr-x 1 jch users     7976 May 27 20:35 at91sam9x5ek-nandflashboot-uboot-3.5.3-r3.bin*
-rw-r----- 1 jch users      352 May 27 21:08 md5sums.txt
-rw-r--r-- 1 jch users 46960640 May 27 21:08 ttni-base-image-mtcap-upgrade.bin
-rw-r--r-- 1 jch users 47329280 May 27 21:08 ttni-base-image-mtcap-upgrade-withboot.bin
-rwxr-xr-x 1 jch users   360612 May 27 20:35 u-boot-mtcap-2012.10-r6.bin*

../mlinux-images/5.3.0b/mtcdt:
total 92504
-rw-r----- 1 jch users     8184 May 27 21:10 at91bootstrap_pmecc_padded.bin
-rwxr-xr-x 1 jch users     7976 May 27 21:10 at91sam9x5ek-nandflashboot-uboot-3.5.3-r3.bin*
-rw-r----- 1 jch users      352 May 27 21:20 md5sums.txt
-rw-r--r-- 1 jch users 46981120 May 27 21:20 ttni-base-image-mtcdt-upgrade.bin
-rw-r--r-- 1 jch users 47349760 May 27 21:20 ttni-base-image-mtcdt-upgrade-withboot.bin
-rwxr-xr-x 1 jch users   360612 May 27 21:10 u-boot-mtcdt-2012.10-r6.bin*
```

This script assumes that the containerized build environment is
installed as _../mlinux-be/_

# See Also

+ [Pre-built mLinux images using this layer](https://github.com/IthacaThings/mlinux-images)
+ [Ansible configuration for managing Conduits](https://github.com/IthacaThings/ttn-multitech-cm)
+ [Container environment for building mLinux on newer system](https://hub.docker.com/r/jchonig/mlinux-be/)
